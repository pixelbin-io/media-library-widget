(()=>{"use strict";const e=self.console,t=Object.freeze({NONE:0,ERROR:1,WARN:2,INFO:3,LOG:4}),i=["error","warn","info","log"],n=void 0!==e&&"function"==typeof e.log&&"function"==typeof e.error&&"function"==typeof e.debug&&"function"==typeof e.warn&&"function"==typeof Function.prototype.apply;let s;const r=(t,i,n,s)=>{e[i]?n?e[i](n):e[i]():t.log(`----------- ${n||s} ----------- `)},o=(o={})=>{o.level=o.level||t.NONE;const l=o.newInstance||!s?((s={})=>{let o=s.level||t.NONE;const l={setLevel:e=>(o=e,l),getLevel:()=>o||void 0};return i.forEach((t=>{l[t]=(...s)=>{if(n){const n=i.indexOf(t),r=l.getLevel();n>=0&&n+1<=r&&e[t].apply(e,s)}return l}})),l.groupCollapsed=e=>r(l,"groupCollapsed",e,"GROUP START"),l.group=e=>r(l,"group",e,"GROUP START"),l.groupEnd=()=>r(l,"groupEnd",null,"GROUP END"),l.debug=l.log,l})(o):s;return s||o.newInstance||(s=l),l},l=o();o();const a={init:"ML_WIDGET_INIT",show:"ML_WIDGET_SHOW",hide:"ML_WIDGET_HIDE",error:"ML_WIDGET_ERROR",insert:"ML_WIDGET_INSERT_DATA",identity:"ML_WIDGET_EXPOSE_IDENTITY",adjustMultiSelector:"ML_WIDGET_ADJUST_MULTISELECT"},d=["zone_url","access_key","use_saml"],h=["remove_header"],c=["inline_container","z_index","multiple","max_files","default_transformations","insert_caption","remove_header","mode","folder"],m=["datasourceId","sortBy","orderBy","path","fileType"],u=["asset_url"],f=(e,t)=>{let i=null;try{i="string"==typeof e?JSON.parse(e):e}catch(e){l.error(`[postmessage]: failed to parse data from ${t}`,e)}return i};class p extends EventTarget{emit(e,t){const i=new CustomEvent(e,{detail:t});this.dispatchEvent(i)}on(e,t){const i=e=>{if(e.detail){const i=f(e.detail);t(i.data)}else t()};this.addEventListener(e,i),this._listeners||(this._listeners=new Map),this._listeners.has(t)||this._listeners.set(t,i)}off(e,t){if(this._listeners&&this._listeners.has(t)){const i=this._listeners.get(t);this.removeEventListener(e,i),this._listeners.delete(t)}}}function g(e,t,i,n={}){const s=t.dev?t.pixelbinURL:`https://console.${t.pixelbinURL}`;let r=function(e,t,i){let n=[];return Object.entries(e).forEach((([e,t])=>{n.push(`${e}=${encodeURIComponent(t)}`)})),t.filter((e=>Boolean(i[e]))).forEach((e=>{const t=i[e];var s;"object"!=typeof t||Array.isArray(t)?n.push(`${e}=${encodeURIComponent(t)}`):n.push(`${e}=${s=t,Object.keys(s).map((e=>`${e}:${encodeURIComponent(s[e])}`)).join("|")}`)})),n}(n,i,t);return{origin:s,href:`${s}${e}?${r.join("&")}`}}class y extends p{isMediaLibraryVisible=!1;isLibraryLoaded=!1;originalBodyOverflow=null;iframe;fullscreenContainer;messageHandler=null;isFullscreen=!1;pixelbinURL="pixelbinz0.de";constructor({options:e,callbacks:t={},element:i,mlId:n}){super(),e.pixelbinURL=e.pixelbinURL||this.pixelbinURL;const s={...e};this.setupEventHandlers(t),this.isFullscreen=!!e.inline_container;var{initialURL:r,mediaLibraryUrl:o}=function(e,t){const i=e.cloud_name,n=`/organization/${i}/media-library`,s=`/organization/${i}/playground`;let r=self.location;"null"===r.origin&&(r=new URL(self.origin));const o={is_widget:!0,frameHost:`${r.protocol}//${r.host}`,ml_id:t};var l="";return"playground"===e.mode?(e.url=e.asset_url,l=g(s,e,[...d,...h,...u],o)):(e.path=e.folder,l=g(n,e,[...d,...h,...m],o)),{initialURL:l,mediaLibraryUrl:l.href}}(e,n);s.mlUrl=r,s.callbacks=t,this.createIFrameAndContainer(e,o);const p=s,y=c.reduce(((e,t)=>(void 0!==p[t]&&(e[t]=p[t]),e)),{});console.log(r),this.messageHandler=(e=>new Promise(((t,i)=>{var n=!1;const s=function(e){let t,i=e.ifr,n=[e.mlUrl.origin];const s={[a.insert]:e.callbacks.insertHandler,[a.delete]:e.callbacks.deleteHandler,[a.identity]:e.callbacks.identityHandler,[a.hide]:()=>{e.hideCms()},[a.error]:e.callbacks.errorHandler,[a.upload]:e.callbacks.uploadHandler},r=e=>{if(!e||!e.length)throw"PostMessage - target not set!"},o=i=>{var r;if(~n.indexOf(i.origin)&&(t=i.origin,(r=f(i.data,i.origin))&&r.mlId&&r.mlId==e.mlId)){const e=r.type,t=s[e];t&&(l.log(`[postmessage]: found matching handler for '${i.type}' event from: ${i.origin}`,i.data),t(i.data,i.data.type,i))}};return r(n),self.addEventListener("message",o,!1),{send:(e,n,s={})=>{s=s.target||t,r(s);try{l.log(`[postmessage]: posting message to: ${s}`),i=i instanceof HTMLIFrameElement?i.contentWindow:i,i.postMessage(JSON.stringify({type:e,data:n}),s)}catch(e){l.error(`[postmessage]: failed to post message to target: ${s}`,e)}},close:()=>self.removeEventListener("message",o)}}(e),r=(t,i)=>{s.send(t,i,{target:e.mlUrl.origin})};e.ifr.addEventListener("load",(()=>{n||(n=!0,e.iframeLoaded(),t({sendMessage:r}))})),self.addEventListener("message",(t=>{let i=f(t);i=f(i.data),i&&"object"==typeof i&&"consoleLoaded"===i.type&&r(a.init,e)}),!1),e.ifr.addEventListener("error",(function(){}))})))({ifr:this.iframe,mlId:n,mlUrl:r,callbacks:{uploadHandler:this.emitUploadData.bind(this),errorHandler:this.emitErrorData.bind(this),identityHandler:this.emitIdentityData.bind(this),deleteHandler:this.emitDeleteData.bind(this),insertHandler:e=>{this.emitInsertData(e),this.isFullscreen||this.handleHide()}},iframeLoaded:this.handleLibraryLoaded,hideCms:this.handleHide,config:y}),this.appendAndFocus(s),this.handleShow(),this.show=(e={})=>(this.messageHandler.then((t=>{t.sendMessage(a.show,{mlId:n,options:{...e,config:e},config:e}),this.handleShow()})),this),this.hide=()=>(this.messageHandler.then((e=>{e.sendMessage(a.hide,{mlId:n}),this.handleHide()})),this)}appendAndFocus(e){var t=this.isFullscreen?this.iframe:this.fullscreenContainer;let i=document.body;if(this.isFullscreen&&(i=e.inline_container,"string"==typeof i&&(i=document.querySelector(i)),!i))throw new Error("Element Not Found ("+e.inline_container+")");i.appendChild(t),this.iframe.focus()}createIFrameAndContainer(e,t){const i=e=>{window.requestAnimationFrame((()=>{e.matches?this.fullscreenContainer.style.padding="25px":this.fullscreenContainer.style.padding="25px 0"}))};if(this.iframe=document.createElement("iframe"),this.iframe.setAttribute("src",t),this.iframe.setAttribute("frameborder","no"),this.iframe.setAttribute("allow","camera"),this.isFullscreen?(this.iframe.setAttribute("width","100%"),this.iframe.setAttribute("height","100%"),this.iframe.style.border="none"):(this.iframe.setAttribute("width","100%"),this.iframe.setAttribute("height","100%"),this.iframe.style.boxShadow="0 0 50px rgba(0, 0, 0, 0.8)"),!this.isFullscreen){if(this.fullscreenContainer=document.createElement("div"),this.fullscreenContainer.style.position="fixed",this.fullscreenContainer.style.top="0",this.fullscreenContainer.style.left="0",this.fullscreenContainer.style.height="100%",this.fullscreenContainer.style.width="100%",this.fullscreenContainer.style.boxSizing="border-box",this.fullscreenContainer.style.backgroundColor="rgba(0,0,0,0.5)",this.fullscreenContainer.style.zIndex=e.z_index||99999,matchMedia){const e=window.matchMedia("(min-width: 700px)");e.addListener(i),i(e)}this.fullscreenContainer.style.visibility="hidden",this.fullscreenContainer.appendChild(this.iframe)}}toggleVisibility=()=>{const e=e=>{27===e.keyCode&&this.hide()},t=()=>{var e=this.iframe.getBoundingClientRect();this.messageHandler.then((t=>{t.sendMessage(a.adjustMultiSelector,{iframeTop:e.top,iframeBottom:e.bottom,viewportHeight:window.innerHeight,iframeHeight:e.height})}))},i=this.isFullscreen?this.iframe:this.fullscreenContainer;this.isLibraryLoaded&&this.isMediaLibraryVisible?(i.style.visibility="visible",i.focus(),this.isFullscreen||document.addEventListener("keyup",e),this.isFullscreen&&(t(),document.addEventListener("scroll",t))):(i.style.visibility="hidden",document.removeEventListener("keyup",e),document.removeEventListener("scroll",t))};handleShow=()=>{!this.isFullscreen&&document.body&&(null===this.originalBodyOverflow&&(this.originalBodyOverflow=document.body.style.overflow),document.body.style.overflow="hidden"),this.isMediaLibraryVisible=!0,this.toggleVisibility(),this.emitShowData()};handleHide=()=>{!this.isFullscreen&&document.body&&null!==this.originalBodyOverflow&&(document.body.style.overflow=this.originalBodyOverflow,this.originalBodyOverflow=null),this.isMediaLibraryVisible=!1,this.toggleVisibility(),this.emitHideData()};handleLibraryLoaded=()=>{this.isLibraryLoaded=!0,this.toggleVisibility()};emitShowData(){return this.emit("show")}emitHideData(){return this.emit("hide")}emitInsertData(e){return this.emit("insert",e)}emitIdentityData(e){return this.emit("identity",e)}emitErrorData(e){return this.emit("error",e)}emitUploadData(e){return this.emit("upload",e)}emitDeleteData(e){return this.emit("delete",e)}setupEventHandlers({showHandler:e=()=>{},hideHandler:t=()=>{},insertHandler:i=()=>{},identityHandler:n=()=>{},errorHandler:s=()=>{}}={}){this.on("show",e),this.on("hide",t),this.on("insert",i),this.on("identity",n),this.on("error",s)}}(e=>{const t=(e,t,i)=>new y({options:e,callbacks:t,element:i,mlId:12345});e.pixelbin=e.pixelbin||{},e.pixelbin.openMediaLibrary=(e,i,n)=>t(e,i,n).show(e),e.pixelbin.createMediaLibrary=(e,i,n)=>t(e,i,n)})(self)})();